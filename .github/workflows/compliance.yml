name: compliance

on:
  - push
  - workflow_dispatch

permissions: read-all

jobs:
  verify-gomodtidy-nochanges:
    strategy:
      matrix:
        platform:
          - ubuntu-latest
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
      - uses: cachix/install-nix-action@7be5dee1421f63d07e71ce6e0a9f8a4b07c2a487 # v31.6.1
        with:
          nix_path: nixpkgs=channel:nixos-25.05
      - run: nix-shell --pure --run 'go mod tidy'
      - run: git diff --exit-code

  check-licenses:
    strategy:
      matrix:
        platform:
          - ubuntu-latest
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
      - uses: cachix/install-nix-action@7be5dee1421f63d07e71ce6e0a9f8a4b07c2a487 # v31.6.1
        with:
          nix_path: nixpkgs=channel:nixos-25.05
      - run: |
          CMD='\
            GOPATH="$PWD/.gopath" go install github.com/google/go-licenses@latest && \
            GOROOT="$(go env GOROOT)" "$PWD/.gopath/bin/go-licenses" check ./... \
              --include_tests \
              --ignore "$(go list -m),modernc.org/mathutil" \
              --allowed_licenses="\
                  MIT \
                , Apache-2.0 \
                , ISC \
                , BSD-2-Clause \
                , BSD-3-Clause \
                , Unlicense \
                , MPL-2.0 \
              " \
          '
          nix-shell --pure --run "$CMD"

  govulncheck:
    strategy:
      matrix:
        platform:
          - ubuntu-latest
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
      - uses: cachix/install-nix-action@7be5dee1421f63d07e71ce6e0a9f8a4b07c2a487 # v31.6.1
        with:
          nix_path: nixpkgs=channel:nixos-25.05
      - run: |
          nix-shell --pure -p go govulncheck gcc --run 'govulncheck -test ./...' || true

  nancy:
    strategy:
      matrix:
        platform:
          - ubuntu-latest
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
      - uses: cachix/install-nix-action@7be5dee1421f63d07e71ce6e0a9f8a4b07c2a487 # v31.6.1
        with:
          nix_path: nixpkgs=channel:nixos-25.05
      - run: |
          CMD='\
            GOPATH="$PWD/.gopath" go install github.com/sonatype-nexus-community/nancy@latest && \
            go list -json -m all | "$PWD/.gopath/bin/nancy" sleuth \
          '
          nix-shell --pure --run "$CMD" || true
