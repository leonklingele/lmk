name: common for pull requests

on:
  - pull_request
  - workflow_dispatch

permissions: read-all

jobs:
  commitlint:
    strategy:
      matrix:
        platform:
          - ubuntu-latest
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0
      - uses: cachix/install-nix-action@7be5dee1421f63d07e71ce6e0a9f8a4b07c2a487 # v31.6.1
        with:
          nix_path: nixpkgs=channel:nixos-25.05
      - run: |
          [[ -f commitlint.config.ts ]] || cat > commitlint.config.ts <<EOF
          export default {
            extends: ['@commitlint/config-conventional'],
            rules: {
              'body-max-line-length': [2, 'always', 200],
              'footer-max-line-length': [2, 'always', 200],
            },
          };
          EOF
      - run: nix-shell -p git nodejs --run 'npm install --save-dev @commitlint/{cli,config-conventional} && npx commitlint --strict --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --config commitlint.config.ts'
